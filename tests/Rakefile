require 'yaml'

# tests run at the garuda/ root
Dir.chdir(File.dirname(__FILE__))
Dir.chdir('..')

task :default => [:testall]
task :testall => [
  :test_languages, 
  :test_garuda,
  :test_run_script,
  :test_simple_install
]


task :test_languages do
  ruby 'tests/languages_test.rb'
end

task :test_garuda do
  Rake::Task["create_repo"].execute
  ruby 'tests/garuda_test.rb'
  Rake::Task["remove_repo"].execute
end


task :test_run_script do
  Rake::Task["create_repo"].execute
  ruby 'tests/run_test.rb'
  Rake::Task["remove_repo"].execute
end

task :test_simple_install do
  Rake::Task["create_install_env"].execute
  ruby  'tests/simple_install_test.rb'
  Rake::Task["cleanup"].execute
end

task :test_simple_install_garuda_hook do
  Rake::Task["create_install_env"].execute
  ruby  'tests/simple_install_garuda_hook_test.rb'
  Rake::Task["cleanup"].execute
end


task :create_repo do
  Dir.chdir('..')
  `mkdir test.git; cd test.git; git --bare init; cd ..`
  `git clone test.git; cd test; echo 'test' > testfile; git add testfile; git commit -m 'testing'; git push origin master; cd ..`
  Dir.chdir(File.dirname(__FILE__))
  Dir.chdir('..')
end

task :remove_repo do
  Dir.chdir('..')
  `rm -rf test; rm -rf test.git`
  Dir.chdir(File.dirname(__FILE__))
  Dir.chdir('..')
end

task :create_install_env do
  `cd tests/tmp 
    mkdir server 
    cd server
    mkdir test.git 
    cd test.git
    git --bare init 
    cd ../..
    mkdir local
    cd local
    git clone ../server/test.git
    cd ../../..`
end

task :cleanup do
  Rake::Task["remove_repo"].execute
  `rm -rf tmp/*`
  `rm -rf tests/tmp/*`
end



# Old stuffz
task :create_destination do
  `mkdir test_destination`
end

task :remove_destination do
  `rm -rf test_destination`
end

task :test_git_extractor do
  Rake::Task["create_repo"].execute
  ruby "tests/git_extractor_test.rb"
  Rake::Task["remove_repo"].execute
end

task :test_rsync do
  Rake::Task["create_repo"].execute
  Rake::Task["create_repo"].execute
  ruby 'tests/rsync_test.rb'
  Rake::Task["remove_repo"].execute
  Rake::Task["remove_destination"].execute
end

task :test_multi_ftp do
  Rake::Task["create_repo"].execute
  ruby 'tests/multi_ftp_test.rb'
  Rake::Task["remove_repo"].execute
end
